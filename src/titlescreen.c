#include "titlescreen.h"

#include "lib/nesdoug.h"
#include "lib/neslib.h"

// === Extern'd zero page symbols, defined in zeropage.h.
extern unsigned char temp0;
#pragma zpsym("temp0") 

extern unsigned char pad1;
#pragma zpsym("pad1") 

extern unsigned char pad1_new;
#pragma zpsym("pad1_new") 

extern unsigned char * cmap;

extern void clear_screen(void);

extern void set_chr_bank_0(unsigned char bank_id);
extern void set_chr_bank_1(unsigned char bank_id);

#pragma rodata-name(push, "BANK4")
#pragma code-name(push, "BANK4")
// Raw title screen data.

const unsigned char const titlescreen[] = {
	0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xd9,0x8e,0xd9,0xe0,0xd9,0x8e,0xf7,0xf9,0xf3,0xff,0xd9,0x8e,0xff,0xff,0xd9,0x8e,0xd9,0x8e,0xd9,0x8e,0xd9,0xe0,0xd9,0xe0,0xd9,0x8e,0xff,0xff,0xff,0xff,0xff,0xff,0x53,0xff,0xf5,0xf8,0xe5,0xe0,0xff,0xff,0x53,0xff,0xf5,0x8e,0xff,0xff,0xf5,0x8e,0xe5,0xe0,0x53,0xff,0xf5,0xf8,0xf5,0xf4,0xf5,0x8e,0xff,0xff,0xff,0xff,0xff,0xff,0xe5,0x8e,0x5c,0x5c,0xf2,0xf4,0xff,0xff,0xe5,0x8e,0xe5,0x8e,0xff,0xff,0xe5,0x8e,0xf2,0xf4,0xe5,0x8e,0x5c,0x5c,0x5c,0xff,0xe5,0x8e,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x00,0x00,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x01,0x02,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0a,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x0b,0x0c,0x0d,0x02,0x0e,0x02,0x0f,0x10,0x11,0x12,0x13,0x14,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x15,0x16,0x17,0x18,0xff,0x19,0x1a,0x1b,0x1c,0x1d,0x1e,0x1f,0x20,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x21,0x22,0x23,0x24,0xff,0xff,0x25,0x26,0x27,0x02,0x28,0x29,0x2a,0x2b,0x2c,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x2d,0x2e,0x2f,0x30,0x31,0x32,0x33,0x34,0xde,0x36,0x37,0x38,0x39,0x3a,0x3b,0x3c,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x3d,0x3e,0x02,0x3f,0x40,0x41,0x42,0x35,0x35,0x35,0x43,0x44,0x45,0x46,0x47,0x48,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x49,0x4a,0x02,0x4b,0x4c,0x02,0x4d,0x35,0x35,0x35,0x35,0x4e,0x4f,0x50,0x51,0x52,0x2c,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x54,0x55,0x56,0x02,0x4b,0x57,0x58,0x59,0x35,0x35,0x35,0x35,0x5a,0x5b,0x35,0x5d,0x5e,0x5f,0xff,0xff,0xff,0x60,0x61,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x62,0x63,0x02,0x02,0x64,0x02,0x65,0x66,0xd4,0x35,0x35,0xdf,0x67,0x35,0x68,0x69,0x6a,0x6b,0xff,0xff,0xff,0x6c,0x6d,0x6e,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x6f,0x63,0x02,0x02,0x70,0x71,0x72,0x73,0xe1,0xd5,0x9c,0x35,0x74,0x75,0x76,0x77,0x78,0x79,0xff,0x7a,0x7b,0x7c,0x7d,0x7e,0x7f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x80,0x81,0x02,0x02,0x82,0x83,0x84,0x85,0xcd,0x35,0x86,0x87,0x88,0xff,0xff,0x89,0x8a,0x8b,0x8c,0x35,0x35,0x35,0x35,0x8f,0x90,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x91,0x92,0x02,0x93,0x94,0x95,0x35,0x96,0x97,0x98,0x99,0xff,0xff,0xff,0x9a,0x9b,0x35,0x35,0x35,0x35,0x35,0x35,0x9d,0x9e,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x9f,0xa0,0x02,0xa1,0xa2,0x35,0x35,0xa3,0xa4,0xa5,0xa6,0xa7,0xff,0xa8,0xa9,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0xaa,0xab,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xad,0xac,0xae,0xaf,0x35,0x35,0xb0,0xb1,0x35,0x35,0xb2,0xff,0xb3,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0xb4,0xb5,0xb6,0xff,0xff,0xff,0xff,0xff,0xff,0x8d,0xb7,0xb8,0x35,0x35,0x35,0xb9,0xba,0x35,0x35,0xbb,0xbc,0xbd,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x8d,0xbe,0x35,0xbf,0xc0,0xc1,0xc2,0xc3,0xc4,0xc5,0x02,0xc6,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc7,0xc8,0xc9,0xca,0xff,0xcb,0x35,0xcc,0xff,0xce,0xcf,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xd0,0xfd,0xd1,0xff,0xd2,0xfe,0xd3,0xff,0xff,0x15,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xd6,0xd7,0xd8,0xff,0xff,0xda,0xdb,0xdc,0xdd,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xe2,0xe3,0xff,0xff,0xff,0x6c,0x02,0xe6,0xe7,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0xe8,0xe9,0xea,0xeb,0x35,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xec,0xed,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0xee,0xef,0xf0,0xf1,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x15,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0xa6,0xa7,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x21,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0xf6,0x35,0x35,0x35,0x35,0xb2,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x49,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0x35,0xb2,0xfa,0xfb,0x35,0x35,0xfc,0xff,0xea,0xfa,0xfa,0xfa,0xfa,0xfa,0xfa,0xba,0xae,0x2f,0x0f,0x0f,0x0f,0xaf,0xaf,0xab,0xaa,0x02,0x00,0x00,0x00,0x88,0xaa,0xaa,0xaa,0x00,0x00,0x00,0x00,0x88,0xaa,0xaa,0xaa,0x00,0x00,0x00,0x88,0xaa,0xaa,0xaa,0xaa,0x22,0x00,0x00,0xa9,0xaa,0xaa,0xaa,0xaa,0xa2,0xa0,0xa9,0xaa,0xaa,0xae,0xeb,0x0a,0x0a,0x0a,0x0a,0x0a,0x0a,0x0a,0x0a,
};

const unsigned char const title_palette_bg[] = {
	0x10, 0x0f, 0x01, 0x32, // Valrigard
	0x10, 0x0f, 0x01, 0x27, // Transition between Valrigard and Grarrl (V's blue and Grarrl's yellow spikes)
	0x10, 0x0f, 0x14, 0x27, // Grarrl 
	0x10, 0x0f, 0x14, 0x30, // Grarrl + Teeth
};

const unsigned char const title_palette_spr[] = {
	0x10, 0x0f, 0x16, 0x30, // White+Red -- Grarrl Mouth, Val Mouth and bottom of T
	0x10, 0x0f, 0x16, 0x26, // Red+Red -- Grarrl Eye
	0x10, 0x0f, 0x16, 0x38, // Red+Yellow -- Valrigard Eye
	0x10, 0x0f, 0x00, 0x30, // Greys -- Button
};

const unsigned char const grarrl_eye_spr[] = {
	0x00, 0x00, 0x08, 1,
	0x08, 0x00, 0x09, 1,
	0x10, 0x00, 0x0A, 1,
	0x00, 0x08, 0x18, 1,
	0x08, 0x08, 0x19, 1,
	0x10, 0x08, 0x1A, 1,
	0x00, 0x10, 0x28, 1,
	0x08, 0x10, 0x29, 1,
	0x10, 0x10, 0x2A, 1,
	0x00, 0x18, 0x38, 1,
	0x08, 0x18, 0x39, 1,
	0x10, 0x18, 0x3A, 1,
	0x01, 0x20, 0x48, 1,
	0x09, 0x20, 0x49, 1,
	0x11, 0x20, 0x4A, 1,
	128
};

const unsigned char const grarrl_mouth_spr[] = {
	0x05, 0x00, 0x00, 0,
	0x0D, 0x00, 0x01, 0,
	0x15, 0x00, 0x02, 0,
	0x00, 0x08, 0x03, 0,
	0x08, 0x08, 0x04, 0,
	0x10, 0x08, 0x05, 0,
	0x18, 0x08, 0x06, 0,
	0x20, 0x08, 0x07, 0,
	0x0B, 0x10, 0x10, 0,
	0x13, 0x10, 0x11, 0,
	0x1B, 0x10, 0x12, 0,
	0x23, 0x10, 0x13, 0,
	0x2B, 0x10, 0x14, 0,
	0x1C, 0x18, 0x15, 0,
	0x24, 0x18, 0x16, 0,
	0x2C, 0x18, 0x17, 0,
	0x2F, 0x20, 0x20, 0,
	128
};

const unsigned char const valrigard_face_spr[] = {
	0x0A, 0x02, 0x0B, 2, // Close Eyebrow
	0x00, 0x08, 0x0C, 2, // Close Eye
	0x08, 0x08, 0x0D, 2,
	0x00, 0x10, 0x1C, 2,
	0x08, 0x10, 0x1D, 2,
	0x0F, 0x00, 0x0E, 2, // Far eye
	0x14, 0x06, 0x1E, 2, // Snout
	0x0D, 0x12, 0x2D, 0, // Mouth
	0x15, 0x12, 0x2E, 0, 
	0x0D, 0x1A, 0x2C, 0,
	128
};

const unsigned char const t_bottom_spr[] = {
	0x00, 0x00, 0x0F, 0,
	0x00, 0x08, 0x1F, 0,
	128
};

const unsigned char const button_press_spr0[] = {
	0x00, 0x00, 0x3E, 3,
	0x08, 0x00, 0x3E, 3|OAM_FLIP_H,
	0x00, 0x08, 0x4E, 3,
	0x08, 0x08, 0x4E, 3|OAM_FLIP_H,
	128
};

const unsigned char const button_press_spr1[] = {
	0x00, 0x00, 0x3F, 3,
	0x08, 0x00, 0x3F, 3|OAM_FLIP_H,
	0x00, 0x08, 0x4F, 3,
	0x08, 0x08, 0x4F, 3|OAM_FLIP_H,
	128
};

// Note: this darkens the screen, which will need to be returned to normal again with pal_bright(4) 
void show_title_screen(void) {
	temp0 = 0; // Show the animated button press if temp0 != 0

	ppu_off();
	clear_screen();

    // Load the palettes
    pal_bg(title_palette_bg);
    pal_spr(title_palette_spr);

    // Switch to the correct CHR banks
    set_chr_bank_0(2);
    set_chr_bank_1(3);

    // Write what the title screen into vram.
    vram_write(titlescreen, 1024);

    // Todo: Figure out why calling LZG_decode here crashes

    ppu_on_all();

    // Move the sprites into place.
 
    while (1) {
		ppu_wait_nmi();

		// Draw sprites.
		oam_clear();
		oam_meta_spr(181, 140, grarrl_eye_spr);
		oam_meta_spr(176, 187, grarrl_mouth_spr);
		oam_meta_spr(100, 89, valrigard_face_spr);
		oam_meta_spr(76, 23, t_bottom_spr);

		if (!get_frame_count()) { // At frame #256...
			temp0 = 1;
		}

		if (temp0) {
			if (get_frame_count() & 64) {
				// Every 64th frame:
				oam_meta_spr(192, 64, button_press_spr1); // Pressed button
			} else {
				oam_meta_spr(192, 64, button_press_spr0); // Depressed button
			}
		}
		
		// Listen for an input
        pad1 = pad_poll(0);
        pad1_new = get_pad_new(0);

        if (pad1_new) {
        	break;
        }
	}

	// Fade to black to hide tile "glitching" due to CHR banking
	pal_fade_to(4, 0);

	oam_clear();

	// Reset the CHR banks
	set_chr_bank_0(0); // Back to the "default" banks
	set_chr_bank_1(1);

}


#pragma rodata-name(pop)
#pragma code-name(pop)